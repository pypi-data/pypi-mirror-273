# Workflow runs only once when the template is first used.
# File can be safely deleted after repo is initialized.
name: Initialize repository
on:
  push:
    branches:
      - main

jobs:
  initialize-package:
    name: Initialize the package
    if: ${{github.event.repository.name != 'aind-library-template'}}
    runs-on: ubuntu-latest
    env:
      REPO_NAME: ${{ github.event.repository.name }}
      GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Rename package
      run: |
        pkg_name=$(echo "${REPO_NAME}" | tr - _)

        echo "Package Name ${pkg_name}"
        mkdir src/${pkg_name}
        touch src/${pkg_name}/__init__.py
        echo '"""Init package"""' >> src/${pkg_name}/__init__.py
        echo '__version__ = "0.0.0"' >> src/${pkg_name}/__init__.py

        cp src/aind_behavior_curriculum_template/upload.py src/${pkg_name}/upload.py

        curr_project_name='name = "aind-behavior-curriculum-template"'
        new_project_name="name = \"${REPO_NAME}\""

        sed -i "s/${curr_project_name}/${new_project_name}/" pyproject.toml
        sed -i "s/aind_behavior_curriculum_template/${pkg_name}/" pyproject.toml

        sed -i "s/aind_behavior_curriculum_template/${pkg_name}/" doc_template/source/conf.py
        sed -i "s/aind-behavior-curriculum-template/${REPO_NAME}/" README.md

    - name: Update pyproject w/ current aind-behavior-curriculum version
      run: |
        sudo apt-get update
        sudo apt-get install jq

        package_name="aind-behavior-curriculum"
        latest_version=$(curl -s "https://pypi.org/pypi/$package_name/json" | jq -r '.info.version')

        current_dependency='"aind-behavior-curriculum >= 0.0.1"'
        new_dependency="\"aind-behavior-curriculum >= ${latest_version}\""
        sed -i "s/${current_dependency}/${new_dependency}/" pyproject.toml

    - name: Commit changes
      uses: EndBug/add-and-commit@v9
      with:
        default_author: github_actions
        message: "ci: version bump [skip actions]"
        add: '["pyproject.toml", "README.md", "src/*", "doc_template/source/conf.py"]'
        remove: '["-r src/aind_behavior_curriculum_template"]'

    - name: Add first tag
      run: |
        git tag v0.0.0
        git push origin v0.0.0

    - name: Disable workflow
      run: |
        gh workflow disable -R $GITHUB_REPOSITORY "${{ github.workflow }}"
