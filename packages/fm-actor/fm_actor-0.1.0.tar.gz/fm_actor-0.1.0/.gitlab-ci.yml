# This file is part of fm-actor, a library for interacting with fm-data files:
# https://gitlab.com/sosy-lab/software/fm-actor
#
# SPDX-FileCopyrightText: 2024 Dirk Beyer <https://www.sosy-lab.org>
#
# SPDX-License-Identifier: MIT

image: python:3.12-slim

stages:
  - lint
  - test
  - build
  - deploy

before_script:
  - python -m pip install hatch

reuse:
  stage: lint
  before_script:
    - python -m pip install reuse
  script:
    - reuse lint

lint:
  stage: lint
  before_script:
    - python -m pip install ruff
  script:
    - ruff check

test:
  stage: test
  script:
    - python -m hatch run test:test

build:
  needs:
    - job: "test"
  stage: build
  script:
    - python -m hatch build
  artifacts:
    paths:
      - dist/*.whl

pypi:
  stage: deploy
  needs:
    - job: "build"
      artifacts: true
  script:
    - pip install -U twine
    - twine upload -u "$TWINE_TOKEN" -p "" dist/*
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d{1,2}\.\d{1,2}\.\d{0,1,2}$/'
      # Always publish tagged commits matching CalVer
      when: on_success
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      # Allow manually pushing to pypi
      when: manual
