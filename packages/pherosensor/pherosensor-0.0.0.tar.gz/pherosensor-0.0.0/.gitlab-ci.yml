image: python:3.9

variables:
  HOME: "$CI_BUILDS_DIR"

before_script:
  - pip install tox

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - .tox
    - .sonar/cache

stages:
  - test
  - quality
  - build

check:
  stage: test
  script:
    - tox -e check
  allow_failure: true

test:
  stage: test
  script:
    - tox -e clean,py39,report
  artifacts:
    reports:
      junit: toxtests.xml
    paths:
      - coverage.xml

package:
  stage: build
  script:
    - tox -e build
    - pip install twine
    - TWINE_PASSWORD=${CI_JOB_TOKEN} TWINE_USERNAME=gitlab-ci-token python -m twine upload --repository-url https://forgemia.inra.fr/api/v4/projects/${CI_PROJECT_ID}/packages/pypi --skip-existing dist/*
    - TWINE_PASSWORD=${PYPI_TOKEN} TWINE_USERNAME=__token__ python -m twine upload dist/*
  artifacts:
    paths:
      - dist/*.whl
  only:
    - main

docs:
  stage: build
  script:
    - tox -e docs
  artifacts:
    paths:
      - dist/docs/*
  only:
    - main

sonar coverage:
  stage: quality
  needs: [ "test" ]
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  script:
    - sonar-scanner -Dsonar.qualitygate.wait=true
  allow_failure: true
  only:
    - master
